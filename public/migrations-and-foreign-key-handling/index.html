<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Migrations and Foreign Key Handling</title>
   <meta name="author" content="Frederik Dietz" />
   <link href="http://feeds.feedburner.com/tom-preston-werner" rel="alternate" title="Frederik Dietz" type="application/atom+xml" />

   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
   <link rel="stylesheet" href="/css/main.css" type="text/css" media="screen, projection" />

   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

<div class="site">
  <div class="title">
    <a href="/">Frederik Dietz</a>
    <a class="extra" href="/">home</a>
  </div>
  
  <div id="post">
A question which came up real quick was how to add a foreign key to your migrations. In my example rails app I'm using a project with a has_many association to tasks, like this:

[sourcecode language='ruby']
class Project < ActiveRecord::Base
  has_many :tasks
end

class Task < ActiveRecord::Base
  belongs_to :project
end

[/sourcecode]

Now I want my task database to look like the following:
<pre>mysql&gt; describe tasks;
+------------+--------------+------+-----+---------+
| Field      | Type         | Null | Key | Default |
+------------+--------------+------+-----+---------+
| id         | int(11)      | NO   | PRI | NULL    |
| title      | varchar(255) | YES  |     | NULL    |
| body       | text         | YES  |     | NULL    |
| status     | tinyint(1)   | YES  |     | NULL    |
| created_at | datetime     | YES  |     | NULL    |
| updated_at | datetime     | YES  |     | NULL    |
| project_id | int(11)      | NO   | MUL | NULL    |
+------------+--------------+------+-----+---------+
7 rows in set (0.00 sec)</pre>
Note, that I've removed the last "extra" column which is usually shown by the MySQL describe command. It only shows the auto_increment for the primary key but it would have overlapped my fixed-width wordpress theme.

First we have to create a new migration for adding a new column using:
<pre>script/generate migration add_project_column</pre>
This will generate an initial ruby file where I only added the two lines to add and delete a column.

[sourcecode language='ruby']
class AddProjectColumn < ActiveRecord::Migration
  def self.up
    add_column :tasks, :project_id, :integer, :null => false
  end

  def self.down
    delete_column :tasks, :project_id
  end
end
[/sourcecode]

Next step is the foreign key which we can put directly in the migration, like this:

[sourcecode language='ruby']
class AddProjectColumn < ActiveRecord::Migration
  def self.up
    add_column :tasks, :project_id, :integer, :null => false

    execute 'ALTER TABLE tasks ADD CONSTRAINT fk_tasks_projects FOREIGN KEY ( project_id ) references projects( id )'
  end

  def self.down
    delete_column :tasks, :project_id

    execute 'ALTER TABLE tasks DROP FOREIGN KEY fk_tasks_projects'
  end
end
[/sourcecode]

Note, that I'm actually executing a MySQL command to add a foreign key. So, this code most probably won't work when used with different databases.

For now this is good enough, but I should probably look into refactoring these two lines by extracting them into a migration helper class. This way it will be easier to modify in a single central place in case the database will be changed.

I'm still searching for database independent foreign key management handled in migrations. So, please let me know if you find a better way to do this! Until then some more <a href="http://wiki.rubyonrails.org/rails/pages/UsingMigrations">readings</a>...

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>27 Sep 2009</span> &raquo; <a href="/caffeinated-simpleton-%25c2%25bb-blog-archive-%25c2%25bb-an-introduction-to-javascript%25e2%2580%2599s-%25e2%2580%259cthis%25e2%2580%259d">Caffeinated Simpleton  » Blog Archive  » An Introduction to JavaScript’s “this”</a></li>
    
      <li><span>19 Sep 2009</span> &raquo; <a href="/adding-columns-to-large-mysql-tables-quickly">Adding Columns to large MySQL Tables Quickly</a></li>
    
      <li><span>08 Sep 2009</span> &raquo; <a href="/state-of-the-couch">State of the Couch</a></li>
    
  </ul>
</div>
  
  <div class="footer">
    <div class="contact">
      <p>
        Frederik Dietz<br />
        fdietz@gmail.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="http://github.com/fdietz/">github.com/fdietz</a><br />
        <a href="http://twitter.com/fdietz/">twitter.com/fdietz</a><br />
      </p>
    </div>
    
    <!-- <div class="rss">
      <a href="http://feeds.feedburner.com/fdietz">
        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
      </a>
    </div> -->
    
  </div>
</div>

<a href="http://github.com/fdietz"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

<!-- Google Analytics -->
<script type="text/javascript">
// var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
// document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
// var pageTracker = _gat._getTracker("UA-6016902-1");
// pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->

</body>
</html>
